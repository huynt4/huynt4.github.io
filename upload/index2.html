<!DOCTYPE html>
<html lang="vi">
<head>
	 <meta charset="UTF-8">
	 <title>Drive Uploader & File Explorer</title>
	 <meta name="viewport" content="width=device-width, initial-scale=1">

	 	 <style>
	 	 /* Global Reset and Base */
	 	 * {
	 	 	 box-sizing: border-box;
	 	 }

	 	 body {
	 	 	 margin: 0;
	 	 	 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	 	 	 background: #f7f9fc; /* N·ªÅn s√°ng, d·ªãu m·∫Øt */
	 	 	 color: #333;
	 	 	 line-height: 1.6;
	 	 }

	 	 /* Header & Navigation */
	 	 header {
	 	 	 background: linear-gradient(135deg, #1e3a8a, #1d4ed8); /* M√†u xanh ƒë·∫≠m h∆°n, sang tr·ªçng */
	 	 	 color: white;
	 	 	 padding: 30px 24px;
	 	 	 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
	 	 	 text-align: center;
	 	 }

	 	 header h1 {
	 	 	 margin: 0;
	 	 	 font-size: 28px;
	 	 	 font-weight: 700;
	 	 }

	 	 header p {
	 	 	 margin: 8px 0 0;
	 	 	 font-size: 14px;
	 	 	 opacity: 0.9;
	 	 }

	 	 /* Main Layout */
	 	 main {
	 	 	 max-width: 1000px;
	 	 	 margin: 30px auto;
	 	 	 padding: 0 20px;
	 	 }

	 	 /* Card (Container) Style */
	 	 .card {
	 	 	 background: #ffffff;
	 	 	 border-radius: 16px; /* Bo g√≥c l·ªõn h∆°n */
	 	 	 padding: 25px 30px;
	 	 	 margin-bottom: 25px;
	 	 	 /* ƒê·ªï b√≥ng nh·∫π v√† tinh t·∫ø */
	 	 	 box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08), 0 2px 5px rgba(0, 0, 0, 0.05);
	 	 	 border: 1px solid #eef1f4;
	 	 	 transition: transform 0.2s;
	 	 }
	 	 
	 	 .card:hover {
	 	 	 transform: translateY(-3px);
	 	 	 box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1), 0 5px 10px rgba(0, 0, 0, 0.05);
	 	 }

	 	 .card h2 {
	 	 	 margin: 0 0 5px;
	 	 	 font-size: 20px;
	 	 	 color: #1e3a8a; /* M√†u ti√™u ƒë·ªÅ kh·ªõp v·ªõi header */
	 	 	 border-bottom: 1px solid #f0f4f8; /* ƒê∆∞·ªùng k·∫ª ph√¢n c√°ch nh·∫π */
	 	 	 padding-bottom: 8px;
	 	 }

	 	 .card small {
	 	 	 display: block;
	 	 	 margin-top: 5px;
	 	 	 color: #6b7280;
	 	 	 font-size: 13px;
	 	 	 margin-bottom: 10px;
	 	 }

	 	 /* Button Styles */
	 	 .buttons-row {
	 	 	 display: flex;
	 	 	 flex-wrap: wrap;
	 	 	 align-items: center;
	 	 	 gap: 12px;
	 	 	 margin-top: 15px;
	 	 }

	 	 .btn {
	 	 	 border: none;
	 	 	 border-radius: 8px; /* Bo g√≥c tinh t·∫ø */
	 	 	 padding: 10px 20px;
	 	 	 font-size: 15px;
	 	 	 font-weight: 600;
	 	 	 cursor: pointer;
	 	 	 display: inline-flex;
	 	 	 align-items: center;
	 	 	 gap: 8px;
	 	 	 transition: all 0.2s ease;
	 	 	 white-space: nowrap;
	 	 }

	 	 .btn-primary {
	 	 	 background: #2563eb;
	 	 	 color: #ffffff;
	 	 	 box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
	 	 }

	 	 .btn-primary:hover:not(:disabled) {
	 	 	 background: #1d4ed8;
	 	 	 transform: translateY(-2px);
	 	 	 box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
	 	 }

	 	 .btn-outline {
	 	 	 background: #ffffff;
	 	 	 color: #111827;
	 	 	 border: 1px solid #d1d5db;
	 	 }

	 	 .btn-outline:hover:not(:disabled) {
	 	 	 background: #f3f4f6;
	 	 	 border-color: #9ca3af;
	 	 }

	 	 .btn:disabled {
	 	 	 opacity: 0.6;
	 	 	 cursor: not-allowed;
	 	 	 box-shadow: none;
	 	 	 transform: none;
	 	 }

	 	 /* Status and Feedback */
	 	 .status {
	 	 	 margin-top: 10px;
	 	 	 padding: 8px 12px;
	 	 	 border-radius: 6px;
	 	 	 font-size: 14px;
	 	 	 border: 1px solid transparent;
	 	 }

	 	 .status strong {
	 	 	 font-weight: 700;
	 	 }

	 	 .status.error {
	 	 	 background: #fef2f2;
	 	 	 color: #dc2626;
	 	 	 border-color: #fca5a5;
	 	 }

	 	 .status.success {
	 	 	 background: #f0fdf4;
	 	 	 color: #16a34a;
	 	 	 border-color: #86efac;
	 	 }

	 	 /* File Input Layout */
	 	 .file-section {
	 	 	 margin-top: 15px;
	 	 	 display: flex;
	 	 	 flex-wrap: wrap;
	 	 	 align-items: center;
	 	 	 gap: 12px;
	 	 }

	 	 /* Progress Bar */
	 	 .progress-bar {
	 	 	 width: 100%;
	 	 	 height: 10px;
	 	 	 background: #e5e7eb;
	 	 	 border-radius: 5px;
	 	 	 margin-top: 8px;
	 	 	 overflow: hidden;
	 	 }

	 	 .progress-bar-inner {
	 	 	 height: 100%;
	 	 	 background: #22c55e;
	 	 	 transition: width 0.3s ease;
	 	 }

	 	 /* Table Styles */
	 	 table {
	 	 	 width: 100%;
	 	 	 border-collapse: separate; /* D√πng separate ƒë·ªÉ √°p d·ª•ng border-radius */
	 	 	 border-spacing: 0;
	 	 	 margin-top: 20px;
	 	 	 font-size: 14px;
	 	 	 border-radius: 10px;
	 	 	 overflow: hidden; /* C·∫ßn thi·∫øt ƒë·ªÉ bo g√≥c ho·∫°t ƒë·ªông */
	 	 	 box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
	 	 }

	 	 th, td {
	 	 	 padding: 12px 15px;
	 	 	 text-align: left;
	 	 	 border-bottom: 1px solid #eef1f4;
	 	 }
	 	 
	 	 tr:last-child td {
	 	 	 border-bottom: none;
	 	 }

	 	 th {
	 	 	 background: #f0f4f8; /* N·ªÅn header table */
	 	 	 font-weight: 600;
	 	 	 color: #4b5563;
	 	 	 text-transform: uppercase;
	 	 	 font-size: 12px;
	 	 }
	 	 
	 	 .folder-row {
	 	 	 cursor: pointer;
	 	 	 transition: background 0.15s;
	 	 }

	 	 .folder-row:hover {
	 	 	 background: #eef1f4;
	 	 }
	 	 
	 	 tr:not(.folder-row):hover {
	 	 	 background: #f9fafb;
	 	 }

	 	 /* Tags and Links */
	 	 .tag {
	 	 	 display: inline-flex;
	 	 	 align-items: center;
	 	 	 padding: 4px 10px;
	 	 	 border-radius: 999px;
	 	 	 background: #dbeafe; /* M√†u n·ªÅn nh·∫π nh√†ng */
	 	 	 color: #1e3a8a;
	 	 	 font-size: 12px;
	 	 	 font-weight: 600;
	 	 }

	 	 .link {
	 	 	 color: #2563eb;
	 	 	 text-decoration: none;
	 	 	 font-weight: 500;
	 	 }

	 	 .link:hover {
	 	 	 text-decoration: underline;
	 	 }
	 	 
	 	 /* Breadcrumb/Path Style */
	 	 #breadcrumb_path {
	 	 	 padding: 10px 15px;
	 	 	 background: #ffffff;
	 	 	 border: 1px solid #eef1f4;
	 	 	 border-radius: 8px;
	 	 	 font-size: 14px;
	 	 	 margin-bottom: 15px;
	 	 }

	 	 /* Footer */
	 	 footer {
	 	 	 text-align: center;
	 	 	 font-size: 13px;
	 	 	 color: #9ca3af;
	 	 	 padding: 20px 0;
	 	 }

	 	 /* Responsive Adjustments */
	 	 @media (max-width: 768px) {
	 	 	 header {
	 	 	 	 padding: 20px 15px;
	 	 	 }
	 	 	 
	 	 	 main {
	 	 	 	 margin: 20px auto;
	 	 	 	 padding: 0 10px;
	 	 	 }

	 	 	 .card {
	 	 	 	 padding: 15px;
	 	 	 	 border-radius: 12px;
	 	 	 }

	 	 	 .btn {
	 	 	 	 padding: 8px 15px;
	 	 	 	 font-size: 14px;
	 	 	 }

	 	 	 .buttons-row {
	 	 	 	 flex-direction: column;
	 	 	 	 align-items: stretch;
	 	 	 	 gap: 10px;
	 	 	 }
	 	 	 
	 	 	 .file-section {
	 	 	 	 flex-direction: column;
	 	 	 	 align-items: stretch;
	 	 	 }

	 	 	 table, thead, tbody, th, td, tr {
	 	 	 	 display: block;
	 	 	 	 width: 100%;
	 	 	 }
	 	 	 
	 	 	 thead tr {
	 	 	 	 position: absolute;
	 	 	 	 top: -9999px;
	 	 	 	 left: -9999px;
	 	 	 }

	 	 	 tr {
	 	 	 	 border: 1px solid #eef1f4;
	 	 	 	 margin-bottom: 10px;
	 	 	 	 border-radius: 8px;
	 	 	 }
	 	 	 
	 	 	 td {
	 	 	 	 border: none;
	 	 	 	 position: relative;
	 	 	 	 padding-left: 50%;
	 	 	 	 text-align: right;
	 	 	 	 font-size: 14px;
	 	 	 }
	 	 	 
	 	 	 td::before {
	 	 	 	 content: attr(data-label);
	 	 	 	 position: absolute;
	 	 	 	 left: 6px;
	 	 	 	 width: 45%;
	 	 	 	 padding-right: 10px;
	 	 	 	 white-space: nowrap;
	 	 	 	 text-align: left;
	 	 	 	 font-weight: 600;
	 	 	 	 color: #4b5563;
	 	 	 	 font-size: 12px;
	 	 	 }
	 	 	 
	 	 	 .folder-row:hover {
	 	 	 	 background: #eef1f4;
	 	 	 }
	 	 }
	 </style>
</head>
<body>
	 <header>
	 	 <h1>Google Drive File Manager</h1>
	 	 <p>Giao di·ªán duy·ªát, upload file v√† th∆∞ m·ª•c ƒë∆°n gi·∫£n</p>
	 </header>

	 <main>
	 	 	 	 <section class="card">
	 	 	 <h2><span role="img" aria-label="kh√≥a">üîë</span> 1. ƒêƒÉng nh·∫≠p Google</h2>
	 	 	 <small>S·ª≠ d·ª•ng Google Identity Services ƒë·ªÉ x√°c th·ª±c v√† c·∫•p quy·ªÅn truy c·∫≠p Drive.</small>

	 	 	 <div class="buttons-row">
	 	 	 	 <button id="authorize_button" class="btn btn-primary" disabled>
	 	 	 	 	 üîê ƒêƒÉng nh·∫≠p Google
	 	 	 	 </button>
	 	 	 	 <button id="signout_button" class="btn btn-outline" disabled>
	 	 	 	 	 üö™ ƒêƒÉng xu·∫•t
	 	 	 	 </button>
	 	 	 </div>

	 	 	 <div id="auth_status" class="status">
	 	 	 	 Tr·∫°ng th√°i: <strong>Ch∆∞a s·∫µn s√†ng</strong> (ƒëang t·∫£i th∆∞ vi·ªán Google...)
	 	 	 </div>
	 	 </section>

	 	 ---

	 	 	 	 <section class="card">
	 	 	 <h2><span role="img" aria-label="m≈©i t√™n l√™n">‚¨ÜÔ∏è</span> 2. Upload File/Th∆∞ m·ª•c</h2>
	 	 	 <small>H·ªó tr·ª£ upload nhi·ªÅu file ho·∫∑c c·∫£ th∆∞ m·ª•c (t√°i t·∫°o l·∫°i c·∫•u tr√∫c folder).</small>

	 	 	 <div class="file-section">
	 	 	 	 	 	 	 	 <label for="file_input_files" class="btn btn-outline">
	 	 	 	 	 üìÑ Ch·ªçn File (nhi·ªÅu file)
	 	 	 	 </label>
	 	 	 	 <input type="file" id="file_input_files" multiple style="display: none;">

	 	 	 	 	 	 	 	 <label for="file_input_folder" class="btn btn-outline">
	 	 	 	 	 üìÅ Ch·ªçn Th∆∞ m·ª•c
	 	 	 	 </label>
	 	 	 	 <input type="file" id="file_input_folder" webkitdirectory style="display: none;">
	 	 	 </div>

	 	 	 <div class="buttons-row">
	 	 	 	 <button id="upload_button" class="btn btn-primary" disabled>
	 	 	 	 	 üöÄ B·∫Øt ƒë·∫ßu Upload l√™n Drive
	 	 	 	 </button>
	 	 	 </div>
	 	 	 
	 	 	 <div id="upload_status" class="status">
	 	 	 	 Ch∆∞a c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn.
	 	 	 </div>
	 	 	 
	 	 	 <div id="progress_display" class="status" style="display: none; margin-top: 10px; padding: 0;">
	 	 	 	 <div id="progress_text" style="padding: 8px 12px; font-weight: 600;"></div>
	 	 	 	 <div class="progress-bar">
	 	 	 	 	 <div id="progress_bar_inner" class="progress-bar-inner" style="width: 0%;"></div>
	 	 	 	 </div>
	 	 	 </div>
	 	 </section>

	 	 ---

	 	 	 	 <section class="card">
	 	 	 <h2><span role="img" aria-label="·ªï ƒëƒ©a">üíæ</span> 3. Duy·ªát Google Drive</h2>
	 	 	 <small>B·∫•m v√†o t√™n th∆∞ m·ª•c ƒë·ªÉ duy·ªát file b√™n trong. K√≠ch th∆∞·ªõc hi·ªÉn th·ªã t·ªëi ƒëa 50 m·ª•c g·∫ßn nh·∫•t.</small>

	 	 	 <div class="buttons-row">
	 	 	 	 <button id="go_back_button" class="btn btn-outline" disabled style="display: none;">
	 	 	 	 	 ‚¨ÖÔ∏è Quay l·∫°i Th∆∞ m·ª•c Cha
	 	 	 	 </button>
	 	 	 	 <button id="list_button" class="btn btn-outline" disabled>
	 	 	 	 	 üîÑ T·∫£i l·∫°i danh s√°ch
	 	 	 	 </button>
	 	 	 </div>
	 	 	 
	 	 	 <div id="breadcrumb_path" class="status" style="margin-top: 15px;">
	 	 	 	 ƒê∆∞·ªùng d·∫´n hi·ªán t·∫°i: <strong>/Drive c·ªßa t√¥i</strong>
	 	 	 </div>

	 	 	 <div id="list_status" class="status">
	 	 	 	 Ch∆∞a t·∫£i danh s√°ch file.
	 	 	 </div>

	 	 	 <table>
	 	 	 	 <thead>
	 	 	 	 	 <tr>
	 	 	 	 	 	 <th>T√™n file</th>
	 	 	 	 	 	 <th>Lo·∫°i</th>
	 	 	 	 	 	 <th>C·∫≠p nh·∫≠t</th>
	 	 	 	 	 	 <th>K√≠ch th∆∞·ªõc</th>
	 	 	 	 	 	 <th>Xem</th>
	 	 	 	 	 </tr>
	 	 	 	 </thead>
	 	 	 	 <tbody id="files_tbody">
	 	 	 	 	 <tr><td colspan="5" style="text-align:center; color: #9ca3af;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch file.</td></tr>
	 	 	 	 </tbody>
	 	 	 </table>
	 	 </section>

	 	 <footer>
	 	 	 ·ª®ng d·ª•ng Demo ¬∑ H√£y nh·ªõ thay <strong>CLIENT_ID</strong> v√† <strong>API_KEY</strong>!
	 	 </footer>
	 </main>

	 <script>
		// TODO: THAY B·∫∞NG TH√îNG TIN TH·∫¨T C·ª¶A B·∫†N ---------------
		const CLIENT_ID = "957298442128-v4c9rc83fud515f2is92p97lojjoiuja.apps.googleusercontent.com"; // OAuth 2.0 Client ID
		const API_KEY = "AIzaSyCxJzJVa5OUlnPDKvyxiUqkIJGQ8-hxZtU"; // API key

		const SCOPES = "https://www.googleapis.com/auth/drive";	
		const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest";
		// -------------------------------------------------------

		let tokenClient;
		let gapiInited = false;
		let gisInited = false;
		const folderIdCache = {}; 
		let filesToUpload = []; 
		
		let currentFolderId = 'root'; 
		let folderHistory = [{ id: 'root', name: 'Drive c·ªßa t√¥i' }];

		const authorizeButton = document.getElementById("authorize_button");
		const signoutButton = document.getElementById("signout_button");
		const authStatus = document.getElementById("auth_status");

		const uploadButton = document.getElementById("upload_button");
		const uploadStatus = document.getElementById("upload_status");
		const fileInputFiles = document.getElementById("file_input_files");
		const fileInputFolder = document.getElementById("file_input_folder");
        
		const progressDisplay = document.getElementById("progress_display");
		const progressText = document.getElementById("progress_text");
		const progressBarInner = document.getElementById("progress_bar_inner");


		const listButton = document.getElementById("list_button");
		const listStatus = document.getElementById("list_status");
		const filesTbody = document.getElementById("files_tbody");
		
		const goBackButton = document.getElementById("go_back_button");
		const breadcrumbPath = document.getElementById("breadcrumb_path");
		
		// X·ª≠ l√Ω n√∫t Quay l·∫°i
		goBackButton.onclick = () => {
			navigateHistory(folderHistory.length - 2);
		};


		// G·ªçi khi api.js load xong
		function gapiLoaded() {
			 gapi.load("client", initializeGapiClient);
		}

		// Kh·ªüi t·∫°o client c·ªßa Google API
		async function initializeGapiClient() {
			 try {
			await gapi.client.init({
				 apiKey: API_KEY,
				 discoveryDocs: [DISCOVERY_DOC],
			});
			gapiInited = true;
			authStatus.textContent = "Th∆∞ vi·ªán Google API ƒë√£ s·∫µn s√†ng. ƒêang ch·ªù Google Identity Services...";
			maybeEnableAuthButton();
			 } catch (error) {
			console.error(error);
			authStatus.textContent = "L·ªói kh·ªüi t·∫°o Google API: " + error.message;
			authStatus.classList.add("error");
			 }
		}

		// G·ªçi khi gsi/client load xong
		function gisLoaded() {
			 tokenClient = google.accounts.oauth2.initTokenClient({
			client_id: CLIENT_ID,
			scope: SCOPES,
			callback: "", 
			 });
			 gisInited = true;
			
			// L·∫Øng nghe s·ª± ki·ªán ch·ªçn file/folder ngay sau khi GIS load
			fileInputFiles.onchange = (e) => {
				filesToUpload = Array.from(e.target.files);
				updateUploadInputStatus();
			};

			fileInputFolder.onchange = (e) => {
				filesToUpload = Array.from(e.target.files);
				updateUploadInputStatus();
			};
			
			 maybeEnableAuthButton();
		}

		// Ch·ªâ enable n√∫t login khi c·∫£ 2 th∆∞ vi·ªán ƒë√£ s·∫µn s√†ng
		function maybeEnableAuthButton() {
			 if (gapiInited && gisInited) {
			authorizeButton.disabled = false;
			authStatus.textContent = "S·∫µn s√†ng. B·∫•m \"ƒêƒÉng nh·∫≠p Google\" ƒë·ªÉ c·∫•p quy·ªÅn.";
			 }
		}

		// C·∫≠p nh·∫≠t tr·∫°ng th√°i sau khi ch·ªçn file/folder
		function updateUploadInputStatus() {
			const count = filesToUpload.length;
			if (count > 0) {
				uploadStatus.textContent = `S·∫µn s√†ng upload ${count} m·ª•c.`;
				uploadStatus.classList.remove("error");
				uploadButton.disabled = false;
			} else {
				uploadStatus.textContent = "Ch∆∞a c√≥ t·ªáp n√†o ƒë∆∞·ª£c ch·ªçn.";
				uploadStatus.classList.remove("error", "success");
				uploadButton.disabled = true;
			}
			progressDisplay.style.display = 'none';
		}

		// Khi b·∫•m ƒêƒÉng nh·∫≠p
		authorizeButton.onclick = () => {
			 authorizeButton.disabled = true;
			 authStatus.textContent = "ƒêang m·ªü popup ƒëƒÉng nh·∫≠p...";

			 tokenClient.callback = async (resp) => {
			if (resp.error !== undefined) {
				 console.error(resp);
				 authStatus.textContent = "L·ªói ƒëƒÉng nh·∫≠p: " + (resp.error || "Unknown error");
				 authStatus.classList.add("error");
				 authorizeButton.disabled = false;
				 return;
			}
			
			authStatus.textContent = "ƒê√£ ƒëƒÉng nh·∫≠p v√† c·∫•p quy·ªÅn cho Google Drive.";
			authStatus.classList.remove("error");
			authStatus.classList.add("success");

			authorizeButton.textContent = "‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p";
			signoutButton.disabled = false;
			listButton.disabled = false;
			updateUploadInputStatus(); 
			
			listFiles(); 
			 };

			 const token = gapi.client.getToken();
			 if (!token) {
			tokenClient.requestAccessToken({ prompt: "select_account" });
			 } else {
			tokenClient.requestAccessToken({ prompt: "" });
			 }
		};

		// ƒêƒÉng xu·∫•t
		signoutButton.onclick = () => {
			 const token = gapi.client.getToken();
			 if (token !== null) {
			google.accounts.oauth2.revoke(token.access_token);
			gapi.client.setToken("");
			 }

			 authorizeButton.textContent = "üîê ƒêƒÉng nh·∫≠p Google";
			 authorizeButton.disabled = false;
			 signoutButton.disabled = true;
			 uploadButton.disabled = true;
			 listButton.disabled = true;
			filesToUpload = []; 
			progressDisplay.style.display = 'none';
			filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch file.</td></tr>';
			listStatus.textContent = "Ch∆∞a t·∫£i danh s√°ch file.";
			
			// Reset ƒëi·ªÅu h∆∞·ªõng
			currentFolderId = 'root';
			folderHistory = [{ id: 'root', name: 'Drive c·ªßa t√¥i' }];
			renderBreadcrumb();

			 authStatus.textContent = "ƒê√£ ƒëƒÉng xu·∫•t. C·∫ßn ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ s·ª≠ d·ª•ng.";
			 authStatus.classList.remove("success");
		};
        
        // =========================================================
        // === H√ÄM X·ª¨ L√ù UPLOAD ===
        // =========================================================
        
		// H√†m ki·ªÉm tra v√† t·∫°o Folder tr√™n Drive n·∫øu c·∫ßn
		async function createFolderIfNeeded(pathSegments, parentId = 'root') {
			let currentParentId = parentId;
			let currentPath = '';

			for (const segment of pathSegments) {
				currentPath = (currentPath ? currentPath + '/' : '') + segment;

				if (folderIdCache[currentPath]) {
					currentParentId = folderIdCache[currentPath];
					continue;
				}

				const query = `name = '${segment.replace(/'/g, "\\'")}' and mimeType = 'application/vnd.google-apps.folder' and '${currentParentId}' in parents and trashed = false`;
				const searchRes = await gapi.client.drive.files.list({
					q: query,
					fields: 'files(id)',
					pageSize: 1,
				});

				if (searchRes.result.files.length > 0) {
					currentParentId = searchRes.result.files[0].id;
				} else {
					const folderMetadata = {
						'name': segment,
						'mimeType': 'application/vnd.google-apps.folder',
						'parents': [currentParentId],
					};

					const createRes = await gapi.client.drive.files.create({
						resource: folderMetadata,
						fields: 'id',
					});
					currentParentId = createRes.result.id;
				}

				folderIdCache[currentPath] = currentParentId;
			}
			return currentParentId;
		}

		// H√†m upload file
		uploadButton.onclick = async () => {
			uploadStatus.classList.remove("error", "success");
			const token = gapi.client.getToken();
			if (!token) {
				uploadStatus.textContent = "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google tr∆∞·ªõc.";
				uploadStatus.classList.add("error");
				return;
			}

			const files = filesToUpload; 
			if (files.length === 0) {
				uploadStatus.textContent = "Vui l√≤ng ch·ªçn file ho·∫∑c th∆∞ m·ª•c ƒë·ªÉ upload.";
				uploadStatus.classList.add("error");
				return;
			}

			uploadButton.disabled = true;
			listButton.disabled = true;
			progressDisplay.style.display = 'block';
			
			let successCount = 0;
			let errorCount = 0;
			
			uploadStatus.textContent = `ƒêang chu·∫©n b·ªã upload ${files.length} m·ª•c...`;

			try {
				Object.keys(folderIdCache).forEach(k => delete folderIdCache[k]); 

				for (let i = 0; i < files.length; i++) {
					const file = files[i];
					const totalSize = file.size;
					const formattedTotalSize = formatBytes(totalSize);

					progressText.textContent = `ƒêang upload ${i + 1}/${files.length}: ${file.name}... (0 B / ${formattedTotalSize})`;
					progressBarInner.style.width = '0%';


					// 1. X·ª≠ l√Ω ƒë∆∞·ªùng d·∫´n th∆∞ m·ª•c cha
					let parentFolderId = 'root'; 

					if (file.webkitRelativePath) {
						const parts = file.webkitRelativePath.split('/');
						const pathSegments = parts.slice(0, -1); 

						if (pathSegments.length > 0) {
							parentFolderId = await createFolderIfNeeded(pathSegments, 'root');
						}
					}

					// 2. Upload file v·ªõi ti·∫øn tr√¨nh hi·ªÉn th·ªã
					const metadata = {
						name: file.name,
						mimeType: file.type || "application/octet-stream",
						parents: [parentFolderId], 
					};
					
					const form = new FormData();
					form.append(
						"metadata",
						new Blob([JSON.stringify(metadata)], { type: "application/json" })
					);
					form.append("file", file);

					const xhr = new XMLHttpRequest();
					
					// H√†m c·∫≠p nh·∫≠t ti·∫øn tr√¨nh
					xhr.upload.onprogress = (event) => {
						if (event.lengthComputable) {
							const uploaded = event.loaded;
							const percent = Math.round((uploaded / totalSize) * 100);
							progressText.textContent = `ƒêang upload ${i + 1}/${files.length}: ${file.name}... (${formatBytes(uploaded)} / ${formattedTotalSize})`;
							progressBarInner.style.width = `${percent}%`;
						}
					};

					xhr.open(
						"POST",
						"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,iconLink,size,mimeType"
					);

					xhr.setRequestHeader("Authorization", "Bearer " + token.access_token);

					await new Promise((resolve, reject) => {
						xhr.onload = () => {
							if (xhr.status >= 200 && xhr.status < 300) {
								successCount++;
								resolve();
							} else {
								errorCount++;
								console.error("L·ªói upload file:", file.name, xhr.responseText);
								reject(new Error(`L·ªói upload: ${xhr.status}`));
							}
						};
						xhr.onerror = () => {
							errorCount++;
							console.error("L·ªói m·∫°ng khi upload:", file.name);
							reject(new Error("L·ªói m·∫°ng/k·∫øt n·ªëi"));
						};
						xhr.send(form);
					});
				}
				
				// C·∫≠p nh·∫≠t tr·∫°ng th√°i cu·ªëi c√πng
				const totalUploaded = successCount + errorCount;
				progressDisplay.style.display = 'none';
				if (errorCount === 0) {
					uploadStatus.textContent = `‚úÖ Upload th√†nh c√¥ng ${successCount}/${totalUploaded} m·ª•c!`;
					uploadStatus.classList.add("success");
					uploadStatus.classList.remove("error");
				} else {
					uploadStatus.textContent = `‚ö†Ô∏è Ho√†n t·∫•t: Upload th√†nh c√¥ng ${successCount}/${totalUploaded} m·ª•c, th·∫•t b·∫°i ${errorCount} m·ª•c. Ki·ªÉm tra console ƒë·ªÉ bi·∫øt chi ti·∫øt.`;
					uploadStatus.classList.add("error");
					uploadStatus.classList.remove("success");
				}

				// Reset filesToUpload v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i
				filesToUpload = []; 
				updateUploadInputStatus(); 

				// N·∫øu upload v√†o th∆∞ m·ª•c hi·ªán t·∫°i, t·∫£i l·∫°i danh s√°ch file
				if (currentFolderId === 'root') {
					await listFiles();
				}
				
			} catch (error) {
				console.error(error);
				progressDisplay.style.display = 'none';
				uploadStatus.textContent = "L·ªói upload t·ªïng qu√°t: " + error.message;
				uploadStatus.classList.add("error");
				uploadStatus.classList.remove("success");
			} finally {
				uploadButton.disabled = false;
				listButton.disabled = false;
			}
		};
        
        // =========================================================
        // === H√ÄM LI·ªÜT K√ä FILE V√Ä ƒêI·ªÄU H∆Ø·ªöNG ===
        // =========================================================
		
		// H√†m ƒëi·ªÅu h∆∞·ªõng l·ªãch s·ª≠
		function navigateHistory(index) {
			if (index < 0 || index >= folderHistory.length - 1) return;
			
			const targetFolder = folderHistory[index];
			folderHistory = folderHistory.slice(0, index + 1);
			
			listFiles(targetFolder.id);
		}
		
		// H√†m render breadcrumb
		function renderBreadcrumb() {
			let path = 'ƒê∆∞·ªùng d·∫´n hi·ªán t·∫°i: ';
			
			// T·∫°o chu·ªói ƒë∆∞·ªùng d·∫´n v·ªõi c√°c th∆∞ m·ª•c cha c√≥ th·ªÉ click ƒë∆∞·ª£c
			path += folderHistory.map((item, index) => {
				if (index < folderHistory.length - 1) {
					// S·ª≠ d·ª•ng function navigateHistory() ƒë·ªÉ chuy·ªÉn th∆∞ m·ª•c
					return `<a href="javascript:void(0)" class="link" onclick="navigateHistory(${index})">${item.name}</a>`;
				}
				return `<strong>${item.name}</strong>`;
			}).join(' / ');
			
			breadcrumbPath.innerHTML = path;
			
			// C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t Quay l·∫°i
			if (folderHistory.length > 1) {
				goBackButton.disabled = false;
				goBackButton.style.display = 'inline-flex';
			} else {
				goBackButton.disabled = true;
				goBackButton.style.display = 'none';
			}
		}


		// List files khi b·∫•m n√∫t
		listButton.onclick = () => {
			// Thi·∫øt l·∫≠p l·∫°i th∆∞ m·ª•c g·ªëc v√† t·∫£i l·∫°i
			folderHistory = [{ id: 'root', name: 'Drive c·ªßa t√¥i' }];
			listFiles('root');
		};

		// H√†m li·ªát k√™ file (nh·∫≠n folderId l√†m tham s·ªë)
		async function listFiles(folderId = 'root') {
			 listStatus.classList.remove("error", "success");
			 const token = gapi.client.getToken();
			 if (!token) {
			listStatus.textContent = "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p Google tr∆∞·ªõc.";
			listStatus.classList.add("error");
			return;
			 }
			
			 // C·∫≠p nh·∫≠t ID th∆∞ m·ª•c hi·ªán t·∫°i
			currentFolderId = folderId;
			renderBreadcrumb(); // C·∫≠p nh·∫≠t ƒë∆∞·ªùng d·∫´n

			 listButton.disabled = true;
			 listStatus.textContent = "ƒêang t·∫£i danh s√°ch file...";
			 filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">ƒêang t·∫£i...</td></tr>';

			 try {
			const response = await gapi.client.drive.files.list({
				 pageSize: 50, // TƒÉng gi·ªõi h·∫°n hi·ªÉn th·ªã
				 fields: "files(id,name,mimeType,modifiedTime,iconLink,webViewLink,size)",
				 // ∆Øu ti√™n hi·ªÉn th·ªã Folder tr∆∞·ªõc, sau ƒë√≥ s·∫Øp x·∫øp theo t√™n
				 orderBy: "folder,name",
				 // Truy v·∫•n: ch·ªâ l·∫•y c√°c m·ª•c c√≥ th∆∞ m·ª•c cha l√† currentFolderId V√Ä KH√îNG B·ªä XO√Å
				 q: `'${currentFolderId}' in parents and trashed = false`, 
			});

			const files = response.result.files || [];
			filesTbody.innerHTML = "";

			if (files.length === 0) {
				 listStatus.textContent = "Kh√¥ng t√¨m th·∫•y file/th∆∞ m·ª•c n√†o trong th∆∞ m·ª•c n√†y.";
				 listStatus.classList.add("success");
				 filesTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #9ca3af;">Th∆∞ m·ª•c n√†y tr·ªëng.</td></tr>';
				 return;
			}

			for (const file of files) {
				 const tr = document.createElement("tr");

				 const isFolder = file.mimeType === 'application/vnd.google-apps.folder';
				 
				 // G·∫Øn s·ª± ki·ªán click v√†o h√†ng n·∫øu ƒë√≥ l√† th∆∞ m·ª•c
				 if (isFolder) {
				tr.classList.add('folder-row');
				tr.onclick = () => {
					// Th√™m th∆∞ m·ª•c v√†o l·ªãch s·ª≠ v√† t·∫£i danh s√°ch file m·ªõi
					folderHistory.push({ id: file.id, name: file.name });
					listFiles(file.id); 
				};
				 }

				 const nameTd = document.createElement("td");
				 nameTd.textContent = file.name || "(Kh√¥ng t√™n)";
			  // Th√™m data-label cho responsive
			  nameTd.setAttribute('data-label', 'T√™n file');

				 const typeTd = document.createElement("td");
				 const tag = document.createElement("span");
				 tag.className = "tag";
				 tag.textContent = isFolder ? "üìÅ Folder" : (file.mimeType || "Unknown");	
				 typeTd.appendChild(tag);
			  typeTd.setAttribute('data-label', 'Lo·∫°i');

				 const modifiedTd = document.createElement("td");
				 modifiedTd.textContent = file.modifiedTime
				? new Date(file.modifiedTime).toLocaleString()
				: "";
			  modifiedTd.setAttribute('data-label', 'C·∫≠p nh·∫≠t');

				 const sizeTd = document.createElement("td");
				 sizeTd.textContent = isFolder	
				? "-" 
				: (file.size ? formatBytes(parseInt(file.size, 10)) : "-");
			  sizeTd.setAttribute('data-label', 'K√≠ch th∆∞·ªõc');

				 const linkTd = document.createElement("td");
			  linkTd.setAttribute('data-label', 'Xem');
				 if (file.webViewLink) {
				const a = document.createElement("a");
				a.href = file.webViewLink;
				a.target = "_blank";
				a.rel = "noopener noreferrer";
				a.className = "link";
				a.textContent = isFolder ? "M·ªü Folder" : "Xem File";
				// N·∫øu l√† folder, kh√¥ng cho ph√©p click v√†o link ·ªü c·ªôt n√†y (v√¨ ƒë√£ click v√†o row)
				if (isFolder) {
					a.style.opacity = '0.7';
					a.onclick = (e) => { e.stopPropagation(); }; // NgƒÉn ch·∫∑n s·ª± ki·ªán click lan truy·ªÅn l√™n row
				}
				linkTd.appendChild(a);
				 } else {
				linkTd.textContent = "-";
				 }

				 tr.appendChild(nameTd);
				 tr.appendChild(typeTd);
				 tr.appendChild(modifiedTd);
				 tr.appendChild(sizeTd);
				 tr.appendChild(linkTd);

				 filesTbody.appendChild(tr);
			}

			listStatus.textContent = `ƒê√£ t·∫£i ${files.length} m·ª•c.`;
			listStatus.classList.add("success");
			 } catch (error) {
			console.error(error);
			listStatus.textContent = "L·ªói t·∫£i danh s√°ch file: " + error.message;
			listStatus.classList.add("error");
			 } finally {
			listButton.disabled = false;
			 }
		}

		// Helper format size
		function formatBytes(bytes) {
			 if (bytes === 0) return "0 B";
			 const k = 1024;
			 const sizes = ["B", "KB", "MB", "GB", "TB"];
			 const i = Math.floor(Math.log(bytes) / Math.log(k));
			 return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
		}
	</script>
	 	 <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
	 <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>