<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debug Truy·ªán - Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n ·∫£nh</title>
  <style>
    body{font-family:Arial;margin:12px;background:#f7f8fb;color:#222}
    header{background:#2b78c8;color:#fff;padding:12px;border-radius:6px}
    main{max-width:1000px;margin:16px auto;padding:8px}
    .comic-page{max-width:100%;display:block;margin:8px 0;border:1px solid #ddd;padding:4px;background:#fff}
    .ok{color:green;font-weight:bold}
    .err{color:#c0392b;font-weight:bold}
    .url-row{padding:6px;background:#fff;margin-bottom:6px;border:1px solid #eee;border-radius:4px}
    .small{font-size:0.9em;color:#555}
    a.btn{display:inline-block;padding:6px 10px;background:#2ecc71;color:#fff;border-radius:4px;text-decoration:none;margin-left:6px}
    .controls{margin:8px 0}
    pre{background:#111;color:#fff;padding:8px;border-radius:6px;overflow:auto}
  </style>
</head>
<body>
  <header>
    <h2>Debug Loader - Hi·ªÉn th·ªã URL v√† tr·∫°ng th√°i load ·∫£nh</h2>
    <div class="small">Sao ch√©p ƒë√® file n√†y t·∫°m th·ªùi ƒë·ªÉ debug. Sau khi s·ª≠a xong, thay l·∫°i file g·ªëc.</div>
  </header>

  <main>
    <div class="controls">
      <!-- Thay gi√° tr·ªã ·ªü ƒë√¢y theo c·∫•u tr√∫c repo c·ªßa b·∫°n -->
      <label>COMIC_ROOT_FOLDER:
        <input id="rootFolder" value="Comic/" style="width:220px"/>
      </label>
      <label style="margin-left:10px">V√≠ d·ª• folder (folder param): 
        <input id="folderInput" value="YugiOh/Chap1" style="width:260px"/>
      </label>
      <button id="startBtn" class="btn">üîé Th·ª≠ t·∫£i</button>
      <button id="openFirst" class="btn" style="background:#3498db">M·ªü 00000 tr·ª±c ti·∫øp</button>
    </div>

    <div id="info" class="small"></div>

    <section id="viewer"></section>

    <h3>Console debug (log)</h3>
    <pre id="consoleLog"></pre>

    <h3>H∆∞·ªõng d·∫´n nhanh ki·ªÉm tra n·∫øu ·∫£nh 404</h3>
    <ol>
      <li>M·ªü link ·∫£nh (nh·∫•n "M·ªü tr·ª±c ti·∫øp") ‚Üí n·∫øu tr√¨nh duy·ªát tr·∫£ 404 th√¨ file ch∆∞a ƒë√∫ng ƒë∆∞·ªùng d·∫´n / ch∆∞a push / t√™n kh√°c (ch·ªØ hoa/th∆∞·ªùng kh√°c).</li>
      <li>Ki·ªÉm tra GitHub Pages: n·∫øu b·∫°n d√πng Pages, URL s·∫Ω d·∫°ng <code>https://username.github.io/repo/</code>. N·∫øu m·ªü raw.githubusercontentusercontent th√¨ link kh√°c.</li>
      <li>M·ªü Developer Tools ‚Üí Network ‚Üí refresh ‚Üí ch·ªçn request ·∫£nh, xem status (200 OK ho·∫∑c 404).</li>
    </ol>
  </main>

<script>
  // debug script
  const MAX_PAGES = 200; // gi·ªõi h·∫°n debug
  const startBtn = document.getElementById('startBtn');
  const viewer = document.getElementById('viewer');
  const consoleLog = document.getElementById('consoleLog');
  const info = document.getElementById('info');
  const openFirst = document.getElementById('openFirst');

  function log(s){
    console.log(s);
    consoleLog.textContent += (new Date()).toLocaleTimeString() + "  " + s + "\\n";
  }

  function makeLink(url, text){
    const a = document.createElement('a');
    a.href = url;
    a.textContent = text || url;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    return a;
  }

  startBtn.addEventListener('click', async ()=>{
    viewer.innerHTML = "";
    consoleLog.textContent = "";
    info.textContent = "B·∫Øt ƒë·∫ßu th·ª≠ load c√°c ·∫£nh (xem console log b√™n d∆∞·ªõi).";

    const root = document.getElementById('rootFolder').value.trim();
    const folder = document.getElementById('folderInput').value.trim();

    if(!root || !folder){
      alert('Nh·∫≠p COMIC_ROOT_FOLDER v√† folder (v√≠ d·ª• YugiOh/Chap1)');
      return;
    }

    log(`COMIC_ROOT_FOLDER = "${root}"`);
    log(`folder param = "${folder}"`);

    let pagesFound = 0;
    let pagesTried = 0;
    const errors = [];

    for(let i=0;i<MAX_PAGES;i++){
      const num = i.toString().padStart(5,'0');
      // 2 c√°ch encode: encodeURI ƒë·ªÉ gi·ªØ d·∫•u slash
      const jpg = encodeURI(root + folder + '/' + num + '.jpg');
      const png = encodeURI(root + folder + '/' + num + '.png');

      // hi·ªÉn th·ªã t·ª´ng d√≤ng URL v√† link ƒë·ªÉ m·ªü tr·ª±c ti·∫øp
      const row = document.createElement('div');
      row.className = 'url-row';
      row.innerHTML = `<div><strong>Trang ${num}</strong> <span class="small"> (th·ª≠ .jpg sau .png)</span></div>`;

      // t·∫°o link m·ªü ƒë·ªÉ ki·ªÉm tra nhanh
      const linkJ = makeLink(jpg, '.jpg');
      const linkP = makeLink(png, '.png');
      row.appendChild(linkJ);
      row.appendChild(linkP);

      // placeholder status span
      const statusSpan = document.createElement('div');
      statusSpan.className = 'small';
      statusSpan.textContent = 'ƒêang ki·ªÉm tra...';
      row.appendChild(statusSpan);

      viewer.appendChild(row);

      // Th·ª≠ load b·∫±ng Image (d√πng onload/onerror ƒë·ªÉ bi·∫øt k·∫øt qu·∫£; CORS c√≥ th·ªÉ block, nh∆∞ng n·∫øu 404 th√¨ onerror)
      const found = await tryImage(jpg);
      if(found){
        pagesFound++;
        statusSpan.innerHTML = `<span class="ok">OK (.jpg)</span> ‚Äî <a target="_blank" href="${jpg}">M·ªü</a>`;
        // th√™m ·∫£nh thu nh·ªè ƒë·ªÉ xem
        const img = document.createElement('img');
        img.src = jpg;
        img.className = 'comic-page';
        row.appendChild(img);
        log(`FOUND: ${jpg}`);
      } else {
        const foundP = await tryImage(png);
        if(foundP){
          pagesFound++;
          statusSpan.innerHTML = `<span class="ok">OK (.png)</span> ‚Äî <a target="_blank" href="${png}">M·ªü</a>`;
          const img = document.createElement('img');
          img.src = png;
          img.className = 'comic-page';
          row.appendChild(img);
          log(`FOUND: ${png}`);
        } else {
          statusSpan.innerHTML = `<span class="err">NOT FOUND</span>`;
          errors.push({num, jpg, png});
          log(`NOT FOUND: tried ${jpg} and ${png}`);
        }
      }

      pagesTried++;
      // N·∫øu ƒë√£ th·ª≠ nhi·ªÅu trang v√† ch∆∞a t√¨m th·∫•y g√¨, b·∫°n c√≥ th·ªÉ break s·ªõm
      if(i>50 && pagesFound===0) {
        log('ƒê√£ th·ª≠ nhi·ªÅu trang (>50) m√† ch∆∞a t√¨m th·∫•y ·∫£nh n√†o ‚Äî d·ª´ng s·ªõm.');
        break;
      }
      // n·∫øu b·∫°n ch·ªâ mu·ªën test v√†i trang ƒë·ªÉ debug, c√≥ th·ªÉ uncomment break sau 20
      // if(i>=20) break;
    }

    info.textContent = `Ho√†n t·∫•t. Th·ª≠ ${pagesTried} trang. T√¨m ƒë∆∞·ª£c ${pagesFound} trang. Xem console log ƒë·ªÉ chi ti·∫øt.`;
    if(errors.length>0){
      log(`M·ªôt s·ªë trang kh√¥ng t√¨m th·∫•y (v√≠ d·ª• ${errors[0].num}). M·ªü link tr·ª±c ti·∫øp ƒë·ªÉ x√°c nh·∫≠n 404 ho·∫∑c ki·ªÉm tra case-sensitive.`);
    }
  });

  openFirst.addEventListener('click', ()=>{
    const root = document.getElementById('rootFolder').value.trim();
    const folder = document.getElementById('folderInput').value.trim();
    const url = encodeURI(root + folder + '/00000.jpg');
    window.open(url, '_blank');
  });

  function tryImage(url){
    return new Promise(resolve=>{
      const img = new Image();
      img.onload = ()=> resolve(true);
      img.onerror = ()=> resolve(false);
      // g√°n src sau handlers
      img.src = url;
      // set timeout in case load hangs due to CORS weirdness
      setTimeout(()=>{ /* n·∫øu ch∆∞a c√≥ onload/onerror sau 6s, treat as false */ }, 6000);
    });
  }
</script>
</body>
</html>
